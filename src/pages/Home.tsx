import React, { useRef } from "react"
import qs from 'qs'
import { useEffect, useState } from 'react';
import { Link, useNavigate } from "react-router-dom";

import PizzaBlock from '../components/PizzaBlock';
import Sort, { sortList } from '../components/Sort';
import Categories from '../components/Categories';
import { Skeleton } from '../components/PizzaBlock/Skeleton';
import Pagination from "../components/Pagination";
import { useDispatch, useSelector } from "react-redux";
import { setCategoryId, setCurrentPage, setFilters } from "../redux/slices/filterSlice";
import { fetchPizzas } from "../redux/slices/pizzasSlice";

export const Home: React.FC = () => {
  
  const navigate = useNavigate();
  const dispatch = useDispatch();
  const isSearch = useRef(false);
  const isMounted = useRef(false);

  const {items, status} = useSelector((state) => state.pizza)
  const {categoryId, sort, currentPage, search} = useSelector((state) => state.filter)

 
    const [orderSort, setOrderSort] = useState('asc')


    const onChangeCategory = (idx: number) => {
        dispatch(setCategoryId(idx))
    }

    const onChangePage = (page: number) => {
        dispatch(setCurrentPage(page))
    }

    const getPizzas = async () => {
          const category = categoryId > 0 ? `category=${categoryId}` : ''; 
          const searchValue = search ? `&search=${search}` : ''; 
          
              dispatch(
                // @ts-ignore
                fetchPizzas({
                category, 
                searchValue, 
                orderSort, 
                currentPage, 
                sortBy: sort.sortProperty,
              }))
        
      }

    // –µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏ –±—ã–ª –ø–µ—Ä–≤—ã–π —Ä–µ–Ω–¥–µ—Ä
      useEffect(() => {
        if (isMounted.current){
          const queryString = qs.stringify({
            sortProperty: sort.sortProperty,
            categoryId,
            currentPage,
            orderSort
          })
          
          navigate(`?${queryString}`)
        }
        isMounted.current = true;
     }, [categoryId, sort, orderSort, currentPage])
  
       // –µ—Å–ª–∏ –±—ã–ª –ø–µ—Ä–≤—ã–π —Ä–µ–Ω–¥–µ—Ä, —Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º URL-–ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Ä–µ–¥–∞–∫—Å–µ
  useEffect(() => {
    if(window.location.search){
      const params = qs.parse(window.location.search.substring(1))
      
      const sort = sortList.find(obj => obj.sortProperty === params.sortProperty);
      
      dispatch(
        setFilters({
          ...params,
          sort
        })
      )
      isSearch.current = true;
    }
  }, [])
   
  // –µ—Å–ª–∏ –±—ã–ª –ø–µ—Ä–≤—ã–π —Ä–µ–Ω–¥–µ—Ä —Ç–æ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–∏—Ü—Ü—ã
  useEffect(() => {
      window.scrollTo(0,0);

      if(!isSearch.current){
        getPizzas();
      }

      isSearch.current = false;
   }, [categoryId, sort, orderSort, search, currentPage])

   

   const pizzas = items.map((obj: any) => (
    <Link key={obj.id} to={`/pizza/${obj.id}`}>
      <PizzaBlock  {...obj} />
    </Link>
    
    ));

  const skeletons = [...new Array(6)].map((_, index)=> <Skeleton key={index}/>);

    return(
            <div className="container">
            <div className="content__top">
            <Categories value={categoryId} onClickCategory={onChangeCategory}/>
            <Sort orderSort={orderSort} onClickOrder={(i: string) => setOrderSort(i)}  />
            </div>
            <h2 className="content__title">–í—Å–µ –ø–∏—Ü—Ü—ã</h2>
            
            {status === 'error' ? (
              <div className="content__error-info">
                <h2>–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ üòï</h2>
                <p>–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø–∏—Ç—Ü—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É –ø–æ–∑–∂–µ.</p>
              </div>
            ) : (
              <div className="content__items">{status === 'loading' ? skeletons : pizzas}</div>
            )}

            <Pagination currentPage={currentPage} onChangePage={onChangePage}/>
        </div>
    )
}

export default Home;